# План диагностики и исправления работы бота

**Дата:** 2025-11-XX  
**Проблема:** Бот не находит ответ на вопрос "когда выплачивается зарплата?" хотя в базе знаний есть ответ

## Анализ текущей логики работы бота

### Текущий поток работы:

1. **Бот получает сообщение** (`bot_webhook.py` или `bot.py`)
2. **Отправляет GET запрос** на `/api/slack/search?query=...`
3. **Эндпоинт `/api/slack/search`** (`backend/app/routers/slack.py`):
   - Сохраняет вопрос в таблицу `questions`
   - Вызывает `process_question()` из `ai_agent_service.py`
   - Если `found=True` и `confidence >= 0.8` → возвращает ответ
   - Иначе → возвращает `found=False, call_manager=True`
4. **`process_question()`** (`ai_agent_service.py`):
   - Анализирует intent через `analyze_intent()`
   - Ищет QA пары через `search_semantic()`, `search_by_keywords()`, `search_full_text()`
   - Генерирует ответ через `synthesize_answer()`
   - Возвращает результат с confidence
5. **Если ответ не найден**, бот пытается сохранить вопрос через `/api/slack/question`
6. **Если сохранение не удалось** → показывается ошибка "техническая ошибка"

## Задачи для диагностики и исправления

- [x] Проверить логику поиска — почему не находит релевантные пары
- [x] Проверить логику `synthesize_answer()` — почему confidence может быть низким
- [x] Проверить обработку ошибок — почему показывается "техническая ошибка" вместо нормального сообщения
- [x] Добавить логирование для отладки
- [x] Исправить найденные проблемы
- [ ] Проверить наличие QA пар о зарплате в базе данных со статусом `approved` (требует применения миграций)
- [ ] Протестировать работу бота

## Версионный лог

### 2025-11-XX — Изменения закоммичены
**Коммит:** b19167a - "Исправлена логика поиска ответов в боте"

### 2025-11-XX — Начало диагностики
**Промпт:** В нашей с тобой базе знаний сейчас есть ответ на вопрос когда выплачивается зарплата. Проверь пожалуйста как работает бот? куда он идет? как он проверяет наличие ответов? Как он как в какой логике он отвечает сейчас так и что нужно сделать чтобы он отвечал нормально.

**Что сделано:**
- ✅ Изучена структура проекта
- ✅ Проанализирована логика работы бота
- ✅ Создан план диагностики
- ✅ Добавлено подробное логирование в роутер slack.py и ai_agent_service.py
- ✅ Исправлена логика поиска — теперь объединяются результаты всех методов поиска (semantic, keyword, fulltext) вместо последовательного использования
- ✅ Улучшен промпт для synthesize_answer() — теперь он более лоялен к оценке confidence и лучше понимает синонимы

### Проблемы, которые были найдены:

1. **Логика поиска была неоптимальной**: В `process_question()` использовались методы поиска последовательно — если `search_semantic()` находил результаты, другие методы не вызывались. Теперь все методы вызываются и результаты объединяются.

2. **Промпт для synthesize_answer был слишком строгим**: Требовал confidence >= 0.8, но не учитывал синонимы и разные формулировки. Улучшен промпт для лучшего понимания синонимов.

3. **Недостаточное логирование**: Не было достаточно логов для диагностики проблем. Добавлено подробное логирование на всех этапах.

